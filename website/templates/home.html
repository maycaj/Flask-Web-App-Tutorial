{% extends "base.html" %} 
{% block title %}Home{% endblock %} 
{% block content %}
<h1 align="center">Audio Notes</h1>
<p class="text-center font-italic"> Click start recording while speaking with your physician to summarize the interaction</p> 
<ul class="list-group list-group-flush" id="notes">
  {% for note in user.notes %}
  <li class="list-group-item">
    <audio controls>
      <source src="{{ url_for('views.get_audio', note_id=note.id) }}" type="audio/wav">
      Your browser does not support audio playback.
    </audio>
    <p class="mt-2"><strong>Transcription:</strong><br>{{ note.transcription }}</p>
    <p class="mt-2"><strong>Explanation and Notes:</strong><br>{{ note.analysis }}</p>
    <small class="text-muted">{{ note.date.strftime('%Y-%m-%d %H:%M:%S') }}</small>
    <button type="button" class="close" data-note-id="{{ note.id }}" onclick="deleteNote(this.getAttribute('data-note-id'))">
      <span aria-hidden="true">&times;</span>
    </button>
  </li>
  {% endfor %}
</ul>

<div class="mt-4" align="center">
  <button id="startRecord" class="btn btn-primary">Start Recording</button>
  <span id="timer">00:00:00</span>
  <button id="stopRecord" class="btn btn-danger" disabled>Stop Recording</button>
</div>

<div align="center">
  <br>
  <p class="text-center font-italic">AI is experimental – double check important information</p>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
</div>
{% endblock %}

{% block javascript %}
<script>
let mediaRecorder;
let audioChunks = [];

document.getElementById('startRecord').addEventListener('click', async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio', audioBlob);

            fetch('/add-note', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                }
            });

            // hide record buttons to allow server time to resopnd
            document.getElementById('startRecord').style.display = 'none';
            document.getElementById('stopRecord').style.display = 'none';
            document.getElementById('timer').style.display = 'none';
            

            audioChunks = [];
        };

        mediaRecorder.start();
        document.getElementById('startRecord').disabled = true;
        document.getElementById('stopRecord').disabled = false;
    } catch (err) {
        console.error('Error accessing microphone:', err);
        alert('Could not access microphone. Please ensure microphone permissions are granted.');
    }
});

    let startTime;
    let timerInterval;

    document.getElementById('startRecord').addEventListener('click', () => {
      startTime = new Date();
      timerInterval = setInterval(updateTimer, 1000);
    });

    function updateTimer() {
      const currentTime = new Date();
      const elapsedTime = currentTime - startTime; // Time difference in milliseconds

      const totalSeconds = Math.floor(elapsedTime / 1000);
      const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
      const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
      const seconds = (totalSeconds % 60).toString().padStart(2, '0');

      document.getElementById('timer').textContent = `${hours}:${minutes}:${seconds}`;
    }

    document.getElementById('stopRecord').addEventListener('click', () => {
      clearInterval(timerInterval);
    });

document.getElementById('stopRecord').addEventListener('click', () => {
    mediaRecorder.stop();
    document.getElementById('startRecord').disabled = false;
    document.getElementById('stopRecord').disabled = true;
});

function deleteNote(noteId) {
  fetch("/delete-note", {
    method: "POST",
    body: JSON.stringify({ noteId: noteId }),
  }).then((_res) => {
    window.location.href = "/";
  });
}

</script>
{% endblock %}